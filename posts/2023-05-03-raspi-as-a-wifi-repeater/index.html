<!doctype html><html lang=en-us prefix="og: https://ogp.me/ns#"><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=content-security-policy content="form-action 'none'; upgrade-insecure-requests; block-all-mixed-content; base-uri 'none'"><meta property="og:title" content="RaspberryPi 3b+をWiFiリピーターとして動かす(イーサネット、WiFiドングル不要) - 忘れないように... 2"><title>RaspberryPi 3b+をWiFiリピーターとして動かす(イーサネット、WiFiドングル不要) - 忘れないように... 2</title><meta property="og:description" content><meta name=description content><meta property="og:author" content="soracat"><meta property="og:url" content="https://s0racat.github.io/posts/2023-05-03-raspi-as-a-wifi-repeater/"><link rel=stylesheet href=../../scss/main.css><link rel=icon href=../../favicon/favicon.ico><link rel=apple-touch-icon sizes=180x180 href=../../favicon/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon/favicon-16x16.png><meta property="og:image" content="/favicon/og-image.png"></head><body><div class=header-nav><header><a href=../../><img src=../../img/icon.jpg alt="icon by Neko" width=50 height=50><h1>忘れないように... 2</h1></a></header><nav><a href=../../posts/ title>Posts</a>
<a href=../../tags/ title>Tags</a></nav></div><div class=article-labels><div class=tags><p><a href=../../tags>Tags:</a> <a href=../../tags/raspberrypi>[raspberrypi]</a> <a href=../../tags/linux>[linux]</a> <a href=../../tags/access%20point>[access point]</a></p></div></div><main><article><div class=article-header><h1>RaspberryPi 3b+をWiFiリピーターとして動かす(イーサネット、WiFiドングル不要)</h1><span class=author-date><p>By <a href=https://github.com/soracat>soracat</a> · Made at: 2023/05/03</p></span></div><div class=article-content><h1 id=環境>環境
<a class=anchor href=#%e7%92%b0%e5%a2%83>🔗</a></h1><p>ArchLinux ARM aarch64</p><p>systemd-networkd + dnsmasq + hostapd + ufw + (dnscrypt-proxy)</p><div class=highlight><pre tabindex=0 style=color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>+--------+         +- RPi -------------------+
</span></span><span style=display:flex><span><span style=color:#eceff4>|</span> router <span style=color:#eceff4>|</span>     <span style=color:#81a1c1>(((</span>-+ 192.168.xxx.xxx<span style=color:#81a1c1>(</span>dhcp<span style=color:#81a1c1>)</span>   <span style=color:#eceff4>|</span>              +-Laptop-------------+
</span></span><span style=display:flex><span>+--------+   wlan0 <span style=color:#eceff4>|</span>     WLAN AP             <span style=color:#eceff4>|</span>              <span style=color:#eceff4>|</span> WLAN Client        <span style=color:#eceff4>|</span>
</span></span><span style=display:flex><span>                   <span style=color:#eceff4>|</span>    192.168.50.1<span style=color:#81a1c1>(</span>static<span style=color:#81a1c1>)</span> +-<span style=color:#81a1c1>)))</span>      <span style=color:#81a1c1>(((</span>-+ 192.168.50.x<span style=color:#81a1c1>(</span>dhcp<span style=color:#81a1c1>)</span> <span style=color:#eceff4>|</span>
</span></span><span style=display:flex><span>                   +-------------------------+ uap0         <span style=color:#eceff4>|</span>                    <span style=color:#eceff4>|</span>
</span></span><span style=display:flex><span>                                                            +--------------------+
</span></span></code></pre></div><h1 id=インストール>インストール
<a class=anchor href=#%e3%82%a4%e3%83%b3%e3%82%b9%e3%83%88%e3%83%bc%e3%83%ab>🔗</a></h1><div class=highlight><pre tabindex=0 style=color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo pacman -S dnsmasq hostapd dnscrypt-proxy ufw --needed
</span></span></code></pre></div><p>dnscrypt-proxyはオプション。</p><h1 id=uap0インターフェースを作成>uap0インターフェースを作成
<a class=anchor href=#uap0%e3%82%a4%e3%83%b3%e3%82%bf%e3%83%bc%e3%83%95%e3%82%a7%e3%83%bc%e3%82%b9%e3%82%92%e4%bd%9c%e6%88%90>🔗</a></h1><div class=highlight><pre tabindex=0 style=color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#81a1c1>echo</span> <span style=color:#a3be8c>&#39;ACTION==&#34;add&#34;, SUBSYSTEM==&#34;ieee80211&#34;, KERNEL==&#34;phy0&#34;, \
</span></span></span><span style=display:flex><span><span style=color:#a3be8c>    RUN+=&#34;/sbin/iw phy %k interface add uap0 type __ap&#34;&#39;</span> <span style=color:#eceff4>|</span> sudo tee /etc/udev/rules.d/90-uap0.rules
</span></span></code></pre></div><p>再起動するとuap0インターフェースが作成される</p><h1 id=uap0インターフェースのipアドレスを固定>uap0インターフェースのIPアドレスを固定
<a class=anchor href=#uap0%e3%82%a4%e3%83%b3%e3%82%bf%e3%83%bc%e3%83%95%e3%82%a7%e3%83%bc%e3%82%b9%e3%81%aeip%e3%82%a2%e3%83%89%e3%83%ac%e3%82%b9%e3%82%92%e5%9b%ba%e5%ae%9a>🔗</a></h1><div class=highlight><pre tabindex=0 style=color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#81a1c1>echo</span> <span style=color:#a3be8c>&#39;[Match]
</span></span></span><span style=display:flex><span><span style=color:#a3be8c>Name=uap0
</span></span></span><span style=display:flex><span><span style=color:#a3be8c>
</span></span></span><span style=display:flex><span><span style=color:#a3be8c>[Network]
</span></span></span><span style=display:flex><span><span style=color:#a3be8c>Address=192.168.50.1/24&#39;</span> <span style=color:#eceff4>|</span> sudo tee /etc/systemd/network/80-wifi-ap.network
</span></span></code></pre></div><h1 id=hostapdの設定>hostapdの設定
<a class=anchor href=#hostapd%e3%81%ae%e8%a8%ad%e5%ae%9a>🔗</a></h1><div class=highlight><pre tabindex=0 style=color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo cp /etc/hostapd/hostapd.conf /etc/hostapd/hostapd.conf.bak
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#81a1c1>echo</span> <span style=color:#a3be8c>&#39;country_code=JP
</span></span></span><span style=display:flex><span><span style=color:#a3be8c>
</span></span></span><span style=display:flex><span><span style=color:#a3be8c>interface=uap0
</span></span></span><span style=display:flex><span><span style=color:#a3be8c>driver=nl80211
</span></span></span><span style=display:flex><span><span style=color:#a3be8c>
</span></span></span><span style=display:flex><span><span style=color:#a3be8c>ssid=raspiap
</span></span></span><span style=display:flex><span><span style=color:#a3be8c># Whether to Broadcast ssid, 0 = off,1 = stealth ssid
</span></span></span><span style=display:flex><span><span style=color:#a3be8c>ignore_broadcast_ssid=0
</span></span></span><span style=display:flex><span><span style=color:#a3be8c>hw_mode=a
</span></span></span><span style=display:flex><span><span style=color:#a3be8c>channel=36
</span></span></span><span style=display:flex><span><span style=color:#a3be8c>ieee80211ac=1
</span></span></span><span style=display:flex><span><span style=color:#a3be8c># MAC Address access control, 0 = off
</span></span></span><span style=display:flex><span><span style=color:#a3be8c>macaddr_acl=0
</span></span></span><span style=display:flex><span><span style=color:#a3be8c># WMM(Wi-Fi Multimedia)
</span></span></span><span style=display:flex><span><span style=color:#a3be8c>wmm_enabled=1
</span></span></span><span style=display:flex><span><span style=color:#a3be8c>
</span></span></span><span style=display:flex><span><span style=color:#a3be8c># https://en.wikipedia.org/wiki/IEEE_802.11d-2001
</span></span></span><span style=display:flex><span><span style=color:#a3be8c>ieee80211d=1
</span></span></span><span style=display:flex><span><span style=color:#a3be8c># https://en.wikipedia.org/wiki/IEEE_802.11h-2003
</span></span></span><span style=display:flex><span><span style=color:#a3be8c>ieee80211h=1
</span></span></span><span style=display:flex><span><span style=color:#a3be8c># https://qiita.com/JhonnyBravo/items/5df2d9b2fcb142b6a67c
</span></span></span><span style=display:flex><span><span style=color:#a3be8c>local_pwr_constraint=3
</span></span></span><span style=display:flex><span><span style=color:#a3be8c>spectrum_mgmt_required=1
</span></span></span><span style=display:flex><span><span style=color:#a3be8c>
</span></span></span><span style=display:flex><span><span style=color:#a3be8c># Use WPA
</span></span></span><span style=display:flex><span><span style=color:#a3be8c>auth_algs=1
</span></span></span><span style=display:flex><span><span style=color:#a3be8c>wpa_key_mgmt=WPA-PSK
</span></span></span><span style=display:flex><span><span style=color:#a3be8c># Use WPA2
</span></span></span><span style=display:flex><span><span style=color:#a3be8c>wpa=2
</span></span></span><span style=display:flex><span><span style=color:#a3be8c># Use CCMP
</span></span></span><span style=display:flex><span><span style=color:#a3be8c>wpa_pairwise=CCMP
</span></span></span><span style=display:flex><span><span style=color:#a3be8c># passphrase
</span></span></span><span style=display:flex><span><span style=color:#a3be8c>wpa_passphrase=passphrase&#39;</span> <span style=color:#eceff4>|</span> sudo tee /etc/hostapd/hostapd.conf
</span></span></code></pre></div><p>設定項目はあまり理解してませんが<code>wpa_passphrase</code>項目を変えると接続時に求められるパスワードを変更できます。</p><h1 id=dnscrypt-proxyの設定オプション>dnscrypt-proxyの設定(オプション)
<a class=anchor href=#dnscrypt-proxy%e3%81%ae%e8%a8%ad%e5%ae%9a%e3%82%aa%e3%83%97%e3%82%b7%e3%83%a7%e3%83%b3>🔗</a></h1><div class=highlight><pre tabindex=0 style=color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo cp /etc/dnscrypt-proxy/dnscrypt-proxy.toml /etc/dnscrypt-proxy/dnscrypt-proxy.toml.bak
</span></span></code></pre></div><p><code>/etc/dnscrypt-proxy/dnscrypt-proxy.toml</code></p><div class=highlight><pre tabindex=0 style=color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-diff data-lang=diff><span style=display:flex><span>...
</span></span><span style=display:flex><span><span style=color:#a3be8c>+listen_addresses = [&#39;127.0.0.1:50000&#39;]
</span></span></span><span style=display:flex><span><span style=color:#a3be8c></span>...
</span></span><span style=display:flex><span><span style=color:#a3be8c>+cache = false
</span></span></span><span style=display:flex><span><span style=color:#a3be8c></span>...
</span></span></code></pre></div><p>listen_addressのポートを50000番に変えてます。多分53ポートはバッティングすると思うので</p><h1 id=dnsmasqの設定>dnsmasqの設定
<a class=anchor href=#dnsmasq%e3%81%ae%e8%a8%ad%e5%ae%9a>🔗</a></h1><p>dnsmasqはdhcp serverとlocal dns cache serverとして動いてくれます。</p><div class=highlight><pre tabindex=0 style=color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo cp /etc/dnsmasq.conf /etc/dnsmasq.conf.bak
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#81a1c1>echo</span> <span style=color:#a3be8c>&#34;# listen interface
</span></span></span><span style=display:flex><span><span style=color:#a3be8c>interface=uap0
</span></span></span><span style=display:flex><span><span style=color:#a3be8c># On systems which support it, dnsmasq binds the wildcard address,
</span></span></span><span style=display:flex><span><span style=color:#a3be8c># even when it is listening on only some interfaces. It then discards
</span></span></span><span style=display:flex><span><span style=color:#a3be8c># requests that it shouldn&#39;t reply to. This has the advantage of
</span></span></span><span style=display:flex><span><span style=color:#a3be8c># working even when interfaces come and go and change address. If you
</span></span></span><span style=display:flex><span><span style=color:#a3be8c># want dnsmasq to really bind only the interfaces it is listening on,
</span></span></span><span style=display:flex><span><span style=color:#a3be8c># uncomment this option. About the only time you may need this is when
</span></span></span><span style=display:flex><span><span style=color:#a3be8c># running another nameserver on the same machine.
</span></span></span><span style=display:flex><span><span style=color:#a3be8c>bind-interfaces
</span></span></span><span style=display:flex><span><span style=color:#a3be8c># dhcp range 2~20, 12hrs to update dhcp lease
</span></span></span><span style=display:flex><span><span style=color:#a3be8c>dhcp-range=192.168.50.2,192.168.50.20,255.255.255.0,12h
</span></span></span><span style=display:flex><span><span style=color:#a3be8c>
</span></span></span><span style=display:flex><span><span style=color:#a3be8c># Never forward plain names (without a dot or domain part)
</span></span></span><span style=display:flex><span><span style=color:#a3be8c>domain-needed
</span></span></span><span style=display:flex><span><span style=color:#a3be8c># Never forward addresses in the non-routed address spaces.
</span></span></span><span style=display:flex><span><span style=color:#a3be8c>bogus-priv
</span></span></span><span style=display:flex><span><span style=color:#a3be8c># upstream dns server
</span></span></span><span style=display:flex><span><span style=color:#a3be8c>server=127.0.0.1#50000
</span></span></span><span style=display:flex><span><span style=color:#a3be8c># don&#39;t read /etc/resolv.conf
</span></span></span><span style=display:flex><span><span style=color:#a3be8c>no-resolv
</span></span></span><span style=display:flex><span><span style=color:#a3be8c># listen for dns server on 192.168.50.1
</span></span></span><span style=display:flex><span><span style=color:#a3be8c>listen-address=192.168.50.1
</span></span></span><span style=display:flex><span><span style=color:#a3be8c># dns cache size
</span></span></span><span style=display:flex><span><span style=color:#a3be8c>cache-size=1000
</span></span></span><span style=display:flex><span><span style=color:#a3be8c>
</span></span></span><span style=display:flex><span><span style=color:#a3be8c>conf-dir=/etc/dnsmasq.d/,*.conf&#34;</span> <span style=color:#eceff4>|</span> sudo tee /etc/dnsmasq.conf
</span></span></code></pre></div><p><code>server</code>オプションは上流DNSキャッシュサーバーを指定できます。</p><p>この例ではさっきセットアップしたdnscrypt-proxyのアドレスとポートを指定しています。</p><h1 id=ipマスカレードを有効化>IPマスカレードを有効化
<a class=anchor href=#ip%e3%83%9e%e3%82%b9%e3%82%ab%e3%83%ac%e3%83%bc%e3%83%89%e3%82%92%e6%9c%89%e5%8a%b9%e5%8c%96>🔗</a></h1><div class=highlight><pre tabindex=0 style=color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#81a1c1>echo</span> <span style=color:#a3be8c>&#39;net.ipv4.ip_forward=1&#39;</span> <span style=color:#eceff4>|</span> sudo tee /etc/sysctl.d/routed-ap.conf
</span></span></code></pre></div><h2 id=ufw>ufw
<a class=anchor href=#ufw>🔗</a></h2><p>iptablesを直接弄るのはやりたくないのでufw経由でiptablesを設定します。</p><div class=highlight><pre tabindex=0 style=color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo cp /etc/default/ufw /etc/default/ufw.bak
</span></span></code></pre></div><p><code>/etc/default/ufw</code></p><div class=highlight><pre tabindex=0 style=color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-diff data-lang=diff><span style=display:flex><span>...
</span></span><span style=display:flex><span><span style=color:#a3be8c>+DEFAULT_FORWARD_POLICY=“ACCEPT&#34;
</span></span></span><span style=display:flex><span><span style=color:#a3be8c></span>...
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo cp /etc/ufw/before.rules /etc/ufw/before.rules.bak
</span></span></code></pre></div><p><code>/etc/ufw/before.rules</code></p><div class=highlight><pre tabindex=0 style=color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>...
</span></span><span style=display:flex><span>*nat
</span></span><span style=display:flex><span>-F
</span></span><span style=display:flex><span>-A POSTROUTING -s 192.168.50.0/24 ! -d 192.168.50.0/24 -j MASQUERADE
</span></span><span style=display:flex><span>COMMIT
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span><span style=color:#616e87;font-style:italic># Don&#39;t delete these required lines, otherwise there will be errors</span>
</span></span><span style=display:flex><span>*filter
</span></span><span style=display:flex><span>...
</span></span></code></pre></div><p>*filterの前に書きます。</p><p>source ipが192.168.50.0/24でdestination ipが192.168.50.0/24でないパケットをIPマスカレードするルールです</p><h1 id=systemdで起動時有効化>systemdで起動時有効化
<a class=anchor href=#systemd%e3%81%a7%e8%b5%b7%e5%8b%95%e6%99%82%e6%9c%89%e5%8a%b9%e5%8c%96>🔗</a></h1><div class=highlight><pre tabindex=0 style=color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo systemctl <span style=color:#81a1c1>enable</span> ufw dnscrypt-proxy dnsmasq hostapd --now
</span></span></code></pre></div><h1 id=ufw許可>ufw許可
<a class=anchor href=#ufw%e8%a8%b1%e5%8f%af>🔗</a></h1><div class=highlight><pre tabindex=0 style=color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo ufw allow dns
</span></span><span style=display:flex><span>sudo ufw allow 67/udp
</span></span></code></pre></div><h1 id=再起動>再起動
<a class=anchor href=#%e5%86%8d%e8%b5%b7%e5%8b%95>🔗</a></h1><div class=highlight><pre tabindex=0 style=color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo systemctl reboot
</span></span></code></pre></div><h1 id=参考元>参考元
<a class=anchor href=#%e5%8f%82%e8%80%83%e5%85%83>🔗</a></h1><p><a href=https://www.raspberrypi.com/documentation/computers/configuration.html#setting-up-a-routed-wireless-access-point>https://www.raspberrypi.com/documentation/computers/configuration.html#setting-up-a-routed-wireless-access-point</a></p><p><a href=https://docs.raspap.com/ap-sta/>https://docs.raspap.com/ap-sta/</a></p><p><a href=https://www.mikan-tech.net/entry/raspi-ap-sta-router>https://www.mikan-tech.net/entry/raspi-ap-sta-router</a></p><p><a href=https://qiita.com/hoto17296/items/3aa5863ba9ef13400283>https://qiita.com/hoto17296/items/3aa5863ba9ef13400283</a></p><p><a href=https://www.itmedia.co.jp/news/spv/2008/14/news042.html>https://www.itmedia.co.jp/news/spv/2008/14/news042.html</a></p><p><a href=https://github.com/imp/dnsmasq/blob/master/dnsmasq.conf.example>https://github.com/imp/dnsmasq/blob/master/dnsmasq.conf.example</a></p></div></article></main><div class=article-related><p>Previous: <a href=https://s0racat.github.io/posts/2022-12-12-arch-secureboot-with-grub/>archlinuxでセキュアブート with grub</a></p></div><div class=article-license></div><footer><p>© 2023 - soracat</footer></body></html>