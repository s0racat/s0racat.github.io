<!doctype html><html lang=en-us prefix="og: https://ogp.me/ns#"><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=content-security-policy content="form-action 'none'; upgrade-insecure-requests; block-all-mixed-content; base-uri 'none'"><meta property="og:title" content="archlinuxでセキュアブート with grub - 忘れないように... 2"><title>archlinuxでセキュアブート with grub - 忘れないように... 2</title><meta property="og:description" content><meta name=description content><meta property="og:author" content="soracat"><meta property="og:url" content="https://soracqt.github.io/posts/2022-12-12-arch-secureboot-with-grub/"><link rel=stylesheet href=../../scss/main.css><link rel=icon href=../../favicon/favicon.ico><link rel=apple-touch-icon sizes=180x180 href=../../favicon/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon/favicon-16x16.png><meta property="og:image" content="/favicon/og-image.png"></head><body><div class=header-nav><header><a href=../../><img src=../../img/icon.jpg alt="icon by Neko" width=50 height=50><h1>忘れないように... 2</h1></a></header><nav><a href=../../posts/ title>Posts</a>
<a href=../../tags/ title>Tags</a></nav></div><div class=article-labels><div class=tags><p><a href=../../tags>Tags:</a> <a href=../../tags/archlinux>[archlinux]</a> <a href=../../tags/secureboot>[secureboot]</a> <a href=../../tags/bootloader>[bootloader]</a> <a href=../../tags/efi>[efi]</a></p></div></div><main><article><div class=article-header><h1>archlinuxでセキュアブート with grub</h1><span class=author-date><p>By <a href=https://github.com/soracqt>soracat</a> · Made at: 2022/12/12</p></span></div><div class=article-content><p>こっち(<a href=../../posts/2021-03-09-arch-secureboot/>2021-03-09-arch-secureboot</a>)が古くなってたので書きました。</p><p>いちいちhashをenrollしなくてもいい版です。</p><h2 id=インストール>インストール
<a class=anchor href=#%e3%82%a4%e3%83%b3%e3%82%b9%e3%83%88%e3%83%bc%e3%83%ab>🔗</a></h2><div class=highlight><pre tabindex=0 style=color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>yay -S shim-signed mokutil sbsigntools
</span></span></code></pre></div><h2 id=鍵作成>鍵作成
<a class=anchor href=#%e9%8d%b5%e4%bd%9c%e6%88%90>🔗</a></h2><div class=highlight><pre tabindex=0 style=color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>mkdir -p /var/lib/shim-signed
</span></span><span style=display:flex><span><span style=color:#81a1c1>cd</span> !$
</span></span><span style=display:flex><span>openssl req -newkey rsa:4096 -noenc -keyout MOK.key -new -x509 -sha256 -days <span style=color:#b48ead>3650</span> -subj <span style=color:#a3be8c>&#34;/CN=my Machine Owner Key/&#34;</span> -out MOK.crt
</span></span><span style=display:flex><span>openssl x509 -outform DER -in MOK.crt -out MOK.cer <span style=color:#616e87;font-style:italic># MokManagerにenrollするのにDERフォーマットな証明書が必要</span>
</span></span></code></pre></div><h2 id=grubのstandalone版を生成>grubのstandalone版を生成
<a class=anchor href=#grub%e3%81%aestandalone%e7%89%88%e3%82%92%e7%94%9f%e6%88%90>🔗</a></h2><div class=highlight><pre tabindex=0 style=color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>grub-mkconfig -o /tmp/grub.cfg
</span></span><span style=display:flex><span>grub-mkstandalone -O x86_64-efi --sbat<span style=color:#81a1c1>=</span>/usr/share/grub/sbat.csv -o /boot/efi/EFI/arch/grubx64.efi <span style=color:#a3be8c>&#34;/boot/grub/grub.cfg=/tmp/grub.cfg&#34;</span>
</span></span></code></pre></div><h2 id=さっきの鍵で起動したいファイルに署名>さっきの鍵で起動したいファイルに署名
<a class=anchor href=#%e3%81%95%e3%81%a3%e3%81%8d%e3%81%ae%e9%8d%b5%e3%81%a7%e8%b5%b7%e5%8b%95%e3%81%97%e3%81%9f%e3%81%84%e3%83%95%e3%82%a1%e3%82%a4%e3%83%ab%e3%81%ab%e7%bd%b2%e5%90%8d>🔗</a></h2><div class=highlight><pre tabindex=0 style=color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sbsign --key MOK.key --cert MOK.crt --output /boot/vmlinuz-linux /boot/vmlinuz-linux
</span></span><span style=display:flex><span>sbsign --key MOK.key --cert MOK.crt --output /boot/efi/EFI/arch/grubx64.efi /boot/efi/EFI/arch/grubx64.efi
</span></span></code></pre></div><h2 id=shimとmokmanagerのefiバイナリをコピー--nvramにエントリ作成>shimとMokManagerのefiバイナリをコピー && NVRAMにエントリ作成
<a class=anchor href=#shim%e3%81%a8mokmanager%e3%81%aeefi%e3%83%90%e3%82%a4%e3%83%8a%e3%83%aa%e3%82%92%e3%82%b3%e3%83%94%e3%83%bc--nvram%e3%81%ab%e3%82%a8%e3%83%b3%e3%83%88%e3%83%aa%e4%bd%9c%e6%88%90>🔗</a></h2><div class=highlight><pre tabindex=0 style=color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cp /usr/share/shim-signed/shimx64.efi /boot/efi/EFI/arch/BOOTx64.EFI
</span></span><span style=display:flex><span>cp /usr/share/shim-signed/mmx64.efi /boot/efi/EFI/arch/
</span></span><span style=display:flex><span>cp /var/lib/shim-signed/MOK.cer /boot/efi/EFI/arch/
</span></span><span style=display:flex><span>efibootmgr --unicode --disk /dev/nvme0n1 --part <span style=color:#b48ead>1</span> --create --label <span style=color:#a3be8c>&#34;Shim&#34;</span> --loader <span style=color:#a3be8c>&#34;\EFI\arch\BOOTx64.EFI&#34;</span>
</span></span></code></pre></div><p>それぞれのUEFIの設定を変更するなどしてShimを起動 > Enroll key from disk > Mok.cerを選択 > Continue > Yes > Continue Boot</p><h2 id=mokmanagerにenrollしたcerを削除>MokManagerにenrollした.cerを削除
<a class=anchor href=#mokmanager%e3%81%abenroll%e3%81%97%e3%81%9fcer%e3%82%92%e5%89%8a%e9%99%a4>🔗</a></h2><div class=highlight><pre tabindex=0 style=color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>mokutil --delete /var/lib/shim-signed/MOK.cer
</span></span></code></pre></div><h2 id=アップグレードされたカーネルに署名を自動化>アップグレードされたカーネルに署名を自動化
<a class=anchor href=#%e3%82%a2%e3%83%83%e3%83%97%e3%82%b0%e3%83%ac%e3%83%bc%e3%83%89%e3%81%95%e3%82%8c%e3%81%9f%e3%82%ab%e3%83%bc%e3%83%8d%e3%83%ab%e3%81%ab%e7%bd%b2%e5%90%8d%e3%82%92%e8%87%aa%e5%8b%95%e5%8c%96>🔗</a></h2><p><a href=https://wiki.archlinux.org/title/Secure_Boot#shim_with_key>https://wiki.archlinux.org/title/Secure_Boot#shim_with_key</a></p><h2 id=参考>参考
<a class=anchor href=#%e5%8f%82%e8%80%83>🔗</a></h2><p><a href=https://wiki.archlinux.org/title/Secure_Boot#shim>https://wiki.archlinux.org/title/Secure_Boot#shim</a></p></div></article></main><div class=article-related><p>Previous: <a href=https://soracqt.github.io/posts/2022-08-17-linux-performance-and-powersave/>Linux環境でのパフォーマンス向上と省電力化、発熱防止</a></p></div><div class=article-license></div><footer><p>© 2022 - soracat</footer></body></html>